<!DOCTYPE html>
<html lang="vi" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.69.0" />
    <meta name="description" content="">
<meta name="author" content="journeyoftheaverageguy@gmail.com">

    <link rel="icon" href="/images/favicon.png" type="image/png">

    <title>Cấu hình Site-to-Site VPN :: Thiết lập VPC</title>

    
    <link href="/css/nucleus.css?1611462586" rel="stylesheet">
    <link href="/css/fontawesome-all.min.css?1611462586" rel="stylesheet">
    <link href="/css/hybrid.css?1611462586" rel="stylesheet">
    <link href="/css/featherlight.min.css?1611462586" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1611462586" rel="stylesheet">
    <link href="/css/auto-complete.css?1611462586" rel="stylesheet">
    <link href="/css/atom-one-dark-reasonable.css?1611462586" rel="stylesheet">
    <link href="/css/theme.css?1611462586" rel="stylesheet">
    <link href="/css/hugo-theme.css?1611462586" rel="stylesheet">
    
    <link href="/css/theme-workshop.css?1611462586" rel="stylesheet">
    
    

    <script src="/js/jquery-3.3.1.min.js?1611462586"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/vi/2-vpc-security-basic/3-setup-site-to-site-vpn/">
    <nav id="sidebar" class="showVisitedLinks">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="/">

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 30" width="30%"><defs><style>.cls-1{fill:#fff;}.cls-2{fill:#f90;fill-rule:evenodd;}</style></defs><title>AWS-Logo_White-Color</title><path class="cls-1" d="M14.09,10.85a4.7,4.7,0,0,0,.19,1.48,7.73,7.73,0,0,0,.54,1.19.77.77,0,0,1,.12.38.64.64,0,0,1-.32.49l-1,.7a.83.83,0,0,1-.44.15.69.69,0,0,1-.49-.23,3.8,3.8,0,0,1-.6-.77q-.25-.42-.51-1a6.14,6.14,0,0,1-4.89,2.3,4.54,4.54,0,0,1-3.32-1.19,4.27,4.27,0,0,1-1.22-3.2A4.28,4.28,0,0,1,3.61,7.75,6.06,6.06,0,0,1,7.69,6.46a12.47,12.47,0,0,1,1.76.13q.92.13,1.91.36V5.73a3.65,3.65,0,0,0-.79-2.66A3.81,3.81,0,0,0,7.86,2.3a7.71,7.71,0,0,0-1.79.22,12.78,12.78,0,0,0-1.79.57,4.55,4.55,0,0,1-.58.22l-.26,0q-.35,0-.35-.52V2a1.09,1.09,0,0,1,.12-.58,1.2,1.2,0,0,1,.47-.35A10.88,10.88,0,0,1,5.77.32,10.19,10.19,0,0,1,8.36,0a6,6,0,0,1,4.35,1.35,5.49,5.49,0,0,1,1.38,4.09ZM7.34,13.38a5.36,5.36,0,0,0,1.72-.31A3.63,3.63,0,0,0,10.63,12,2.62,2.62,0,0,0,11.19,11a5.63,5.63,0,0,0,.16-1.44v-.7a14.35,14.35,0,0,0-1.53-.28,12.37,12.37,0,0,0-1.56-.1,3.84,3.84,0,0,0-2.47.67A2.34,2.34,0,0,0,5,11a2.35,2.35,0,0,0,.61,1.76A2.4,2.4,0,0,0,7.34,13.38Zm13.35,1.8a1,1,0,0,1-.64-.16,1.3,1.3,0,0,1-.35-.65L15.81,1.51a3,3,0,0,1-.15-.67.36.36,0,0,1,.41-.41H17.7a1,1,0,0,1,.65.16,1.4,1.4,0,0,1,.33.65l2.79,11,2.59-11A1.17,1.17,0,0,1,24.39.6a1.1,1.1,0,0,1,.67-.16H26.4a1.1,1.1,0,0,1,.67.16,1.17,1.17,0,0,1,.32.65L30,12.39,32.88,1.25A1.39,1.39,0,0,1,33.22.6a1,1,0,0,1,.65-.16h1.54a.36.36,0,0,1,.41.41,1.36,1.36,0,0,1,0,.26,3.64,3.64,0,0,1-.12.41l-4,12.86a1.3,1.3,0,0,1-.35.65,1,1,0,0,1-.64.16H29.25a1,1,0,0,1-.67-.17,1.26,1.26,0,0,1-.32-.67L25.67,3.64,23.11,14.34a1.26,1.26,0,0,1-.32.67,1,1,0,0,1-.67.17Zm21.36.44a11.28,11.28,0,0,1-2.56-.29,7.44,7.44,0,0,1-1.92-.67,1,1,0,0,1-.61-.93v-.84q0-.52.38-.52a.9.9,0,0,1,.31.06l.42.17a8.77,8.77,0,0,0,1.83.58,9.78,9.78,0,0,0,2,.2,4.48,4.48,0,0,0,2.43-.55,1.76,1.76,0,0,0,.86-1.57,1.61,1.61,0,0,0-.45-1.16A4.29,4.29,0,0,0,43,9.22l-2.41-.76A5.15,5.15,0,0,1,38,6.78a3.94,3.94,0,0,1-.83-2.41,3.7,3.7,0,0,1,.45-1.85,4.47,4.47,0,0,1,1.19-1.37A5.27,5.27,0,0,1,40.51.29,7.4,7.4,0,0,1,42.6,0a8.87,8.87,0,0,1,1.12.07q.57.07,1.08.19t.95.26a4.27,4.27,0,0,1,.7.29,1.59,1.59,0,0,1,.49.41.94.94,0,0,1,.15.55v.79q0,.52-.38.52a1.76,1.76,0,0,1-.64-.2,7.74,7.74,0,0,0-3.2-.64,4.37,4.37,0,0,0-2.21.47,1.6,1.6,0,0,0-.79,1.48,1.58,1.58,0,0,0,.49,1.18,4.94,4.94,0,0,0,1.83.92L44.55,7a5.08,5.08,0,0,1,2.57,1.6A3.76,3.76,0,0,1,47.9,11a4.21,4.21,0,0,1-.44,1.93,4.4,4.4,0,0,1-1.21,1.47,5.43,5.43,0,0,1-1.85.93A8.25,8.25,0,0,1,42.05,15.62Z"></path><path class="cls-2" d="M45.19,23.81C39.72,27.85,31.78,30,25,30A36.64,36.64,0,0,1,.22,20.57c-.51-.46-.06-1.09.56-.74A49.78,49.78,0,0,0,25.53,26.4,49.23,49.23,0,0,0,44.4,22.53C45.32,22.14,46.1,23.14,45.19,23.81Z"></path><path class="cls-2" d="M47.47,21.21c-.7-.9-4.63-.42-6.39-.21-.53.06-.62-.4-.14-.74,3.13-2.2,8.27-1.57,8.86-.83s-.16,5.89-3.09,8.35c-.45.38-.88.18-.68-.32C46.69,25.8,48.17,22.11,47.47,21.21Z"></path></svg>

</a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1611462586"></script>
<script type="text/javascript" src="/js/auto-complete.js?1611462586"></script>
<script type="text/javascript">
    
        var baseurl = "\/vi";
    
</script>
<script type="text/javascript" src="/js/search.js?1611462586"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          




 
  
    
    <li data-nav-id="/vi/1-create-vpc/" title="Khởi tạo VPC" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-create-vpc/">
          <b>1. </b>Khởi tạo VPC
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/1-create-vpc/1-vpc-introduction/" title="Giới thiệu VPC" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-create-vpc/1-vpc-introduction/">
          <b>1.1. </b>Giới thiệu VPC
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/1-create-vpc/2-create-vpc-subnet/" title="Tạo VPC Subnet" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-create-vpc/2-create-vpc-subnet/">
          <b>1.2. </b>Tạo VPC Subnet
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/1-create-vpc/3-create-internet-gw/" title="Tạo Internet Gateway" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-create-vpc/3-create-internet-gw/">
          <b>1.3. </b>Tạo Internet Gateway
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/1-create-vpc/4-create-natgw/" title="Tạo NAT Gateway" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-create-vpc/4-create-natgw/">
          <b>1.4. </b>Tạo NAT Gateway
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/1-create-vpc/5-build-simple-lab/" title="Thực hành Cơ bản" class="dd-item 
        
        
        
        ">
      <a href="/vi/1-create-vpc/5-build-simple-lab/">
          <b>1.5. </b>Thực hành Cơ bản
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/vi/2-vpc-security-basic/" title="Bảo mật VPC Cơ bản" class="dd-item 
        parent
        
        
        ">
      <a href="/vi/2-vpc-security-basic/">
          <b>2. </b>Bảo mật VPC Cơ bản
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            




 
  
    
    <li data-nav-id="/vi/2-vpc-security-basic/1-configure-nacl-and-sg/" title="Cấu hình NACL &amp; SG" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-vpc-security-basic/1-configure-nacl-and-sg/">
          <b>2.1. </b>Cấu hình NACL &amp; SG
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-vpc-security-basic/3-setup-site-to-site-vpn/" title="Cấu hình Site-to-Site VPN" class="dd-item 
        
        active
        
        ">
      <a href="/vi/2-vpc-security-basic/3-setup-site-to-site-vpn/">
          <b>2.3. </b>Cấu hình Site-to-Site VPN
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
            
            




 
  
    
    <li data-nav-id="/vi/2-vpc-security-basic/2-configure-vpc-flow-logs/" title="Cấu hình VPC Flow Logs" class="dd-item 
        
        
        
        ">
      <a href="/vi/2-vpc-security-basic/2-configure-vpc-flow-logs/">
          <b>2.2. </b>Cấu hình VPC Flow Logs
          
            <i class="fas fa-check read-icon"></i>
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="http://awsstudygroup.com"><i class='fab fa-aws'></i> AWS Study Group - Blog</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://www.facebook.com/groups/660548818043427/"><i class='fab fa-facebook'></i> AWS Study Group - Nhóm FB</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fas fa-language fa-fw"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
                      <option id="en" value="/2-vpc-security-basic/3-setup-site-to-site-vpn/">English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
                      <option id="vi" value="/vi/2-vpc-security-basic/3-setup-site-to-site-vpn/" selected>Tiếng Việt</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
      
      
      
        <li><a class="padding" href="#" data-clear-history-toggle=""><i class="fas fa-history fa-fw"></i> Clear History</a></li>
      
      </ul>
    </section>
    
    <section id="footer">
      <left>
    
    

    

    
</left>

<script async defer src="https://buttons.github.io/buttons.js"></script>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/vi/'>Thiết lập VPC</a> > <a href='/vi/2-vpc-security-basic/'>Bảo mật VPC Cơ bản</a> > Cấu hình Site-to-Site VPN
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Cấu hình Site-to-Site VPN
            </h1>
          

        



	<p>Mặc định từ bên ngoài có thể kết nối TTDL On-premise tới Amazon VPC sử dụng VPN cứng hoặc mềm tùy thuộc mục đích và nhu cầu sử dụng thực thế.<br>
Cụ thể Amazon VPC cung cấp 2 cách để kết nối với môi trường mạng của doanh nghiệp đó là <strong>VPG</strong> and <strong>CGW</strong>.</p>
<ul>
<li>Virtual Private Gateway (<strong>VPG</strong>) là một trung tâm điều khiển kết nối the virtual private network (VPN) được cài đặt ở đầu AWS.</li>
<li>A Customer Gateway (<strong>CGW</strong>) là thành phần đại diện cho thiết bị VPN cứng hoặc mềm được cài đặt ở đầu Khách hàng.</li>
</ul>
<p><strong>VPN tunnel</strong>  sẽ được thiết lập ngay sau khi lưu lượng dữ liệu được truyền tải giữa AWS và hệ thống mạng của khách hàng. Trong kết nối đó, ta phải chỉ rõ loại định tuyến sẽ được sử dụng để đảm bảo an toàn cũng như chất lượng về mặt truyền tải dữ liệu.<br>
Nếu CGW ở phía khách hàng có hỗ trợ Border Gateway Protocol (BGP), thì trong cấu hình VPN connection ta bắt buộc phải đặt định tuyến là dynamic routing.<br>
Còn ngược lại ta phải cấu hình định tuyến kết nối là static routing. Trường hợp sử dụng static routing, ta phải nhập chính xác những định tuyến cần thiết cho việc kết nối từ phía Khách hàng tới VPG được thiết lập ở đầu AWS. Đồng thời định tuyến cho VPC cũng phải được cấu hình <code>propagated</code> để cho phép các tài nguyên có thể trao đổi dữ liệu đi ra và đi vào trong kết nối VPN tunnel giữa AWS với hệ thống mạng của Khách hàng</p>
<p>Amazon VPC cung cấp nhiều loại CGWs, và từng CGW được gán với một VPG nhưng 1 VPG có thể kết hợp với nhiều CGW (many-to-one design). Để hỗ trợ mô hình này thì địa chỉ IP của CGW phải là duy nhất trong một region.<br>
Amazon VPC cũng cung cấp các thông tin cần thiết cho Nhân viên quản trị mnagj có thể cấu hình CGW và thiết lập kết nối VPN tới VPG trên AWS. Kết nối VPN luôn bao gồm 2 Internet Protocol Security (IPSec) tunnels để đảm bảo tính sẵn sàng cao của kết nối.<br>
Bên dưới là những đặc điểm quan trọng mà ta cần nắm về <strong>VPG</strong>, <strong>CGW</strong>, and <strong>VPN</strong>:</p>
<ul>
<li>VPG là thành phần đầu cuối của VPN tunnel nằm trên AWS.</li>
<li>CGW có thể là thiết bị phần cứng hoặc ứng dụng phần mềm nằm ở đầu Khách hàng trong kết nối VPN tunnel.</li>
<li>Bạn phải khởi tạo kết nối VPN tunnel từ CGW tới VPG.</li>
<li>VPG hỗ trợ cả dynamic routing (BGP) và static routing.</li>
<li>Kết nối VPN luôn có 2 tunnels nhằm đảm bảo tính sẵn sàng cao cho kết nối với VPC từ site Khách hàng.</li>
</ul>
<p>Bài lab giúp chúng ta học được cách thiết lập một kết nối Site to Site VPN trong AWS. Trong thực tế, giải pháp này khá được ưa chuộng do ưu điểm giá thành rẻ, đồng thời rất dễ cấu hình do AWS cung cấp hướng dẫn cho từng loại thiết bị phía đầu Customer. Việc Cust bận tâm duy nhất đó là chuẩn bị đường internet để từ đó tạo đường hầm an toàn bí mật (sử dụng ipsec) kết nối tới AWS thông qua AWS VPN tunnel.<br>
Trong phạm vi bài lab, giả lập rằng chúng ta có Main office và Branch office đặt tại 2 VPC thuộc 2 AZ khác nhau để có sự khác biệt về mặt network. Trên mỗi VPC thực hiện tạo 2 EC2 cho phép SSH từ bên ngoài, nhưng không có khả năng kết nối và ping lẫn nhau sử dụng địa chỉ Private IP của mỗi EC2. Việc ta cần làm là cấu hình VPN để các địa chỉ Private IP có thể ping được lẫn nhau sử dụng VPN Site-to-Site.</p>
<p><img src="/images/2-vpc/Lab-Diagram-Site-to-Site.PNG?width=80pc" alt="Lab Diagram"></p>
<p><strong>Nội dung:</strong></p>
<ul>
<li><a href="#1-c%E1%BA%A5u-h%C3%ACnh-network">1. Cấu hình Network</a></li>
<li><a href="#2-kh%E1%BB%9Fi-t%E1%BA%A1o-ec2-tr%C3%AAn-m%E1%BB%97i-vpc">2. Khởi tạo EC2 trên mỗi VPC</a></li>
<li><a href="#3-c%E1%BA%A5u-h%C3%ACnh-site-to-site-vpn-t%E1%BA%A1i-main-office">3. Cấu hình Site to Site VPN tại Main office</a></li>
<li><a href="#4-c%E1%BA%A5u-h%C3%ACnh-site-to-site-vpn-t%E1%BA%A1i-branch-office">4. Cấu hình Site to Site VPN tại Branch office</a></li>
<li><a href="#5-test-ping-t%E1%BB%AB-pub-linux-t%E1%BB%9Bi-pub-linux-bra-v%C3%A0-ng%C6%B0%E1%BB%A3c-l%E1%BA%A1i">5. Test ping từ Pub-Linux tới Pub-Linux-Bra và ngược lại</a></li>
</ul>
<h4 id="1-cấu-hình-network">1. Cấu hình Network</h4>
<ul>
<li>Tạo 2 VPC nằm trên 2 AZ khác nhau
<ul>
<li><strong>VPC-Main-ASG</strong> với CIDR block <code>10.1.0.0/16</code></li>
<li><strong>VPC-Bra-ASG</strong> với CIDR block <code>10.2.0.0/16</code></li>
</ul>
</li>
<li>Tạo Public Subnets trên mỗi VPC
<ul>
<li><strong>Pubsub1-Main-ASG</strong> với CIDR block <code>10.1.1.0/24</code></li>
<li><strong>Pubsub-Bra-ASG</strong> với CIDR block <code>10.2.1.0/24</code></li>
</ul>
</li>
<li>Tạo Internet GW trên mỗi VPC
<ul>
<li><strong>IGW-Main-ASG</strong> được gắn với <strong>VPC-Main-ASG</strong></li>
<li><strong>IGW-Bra-ASG</strong> được gắn với <strong>VPC-Bra-ASG</strong></li>
</ul>
</li>
<li>Sửa lại Default Route Table cho mỗi VPC
<ul>
<li>Names: <strong>RT-Main-ASG</strong>; Routes: <code>Local,0.0.0.0/0</code>  <strong>IGW-Main-ASG</strong></li>
<li>Names: <strong>RT-Bra-ASG</strong>; Routes: <code>Local,0.0.0.0/0</code>  <strong>IGW-Bra-ASG</strong></li>
</ul>
</li>
</ul>
<h4 id="2-khởi-tạo-ec2-trên-mỗi-vpc">2. Khởi tạo EC2 trên mỗi VPC</h4>
<p>Tại thời điểm ban đầu, 2 địa chỉ Private IP của 2 EC2 đều không thể ping được lẫn nhau.</p>
<p><strong>Tạo Security Group cho EC2 thuộc Main Office</strong></p>
<ul>
<li>Security group: Tạo security group mới: <strong>SG-Pub-Main-ASG</strong></li>
<li>Type: <strong>SSH</strong>; Source: <strong>My IP</strong></li>
<li>Type: <strong>All TCP</strong>; Source: Custom, <code>10.2.0.0/16</code></li>
<li>Type: <strong>All UDP</strong>; Source: Custom, <code>10.2.0.0/16</code></li>
<li>Type: <strong>All ICMP - IPv4</strong>; Source: Custom, <code>10.2.0.0/16</code></li>
</ul>
<p><strong>Tạo Security Group cho EC2 thuộc Branch Office</strong></p>
<ul>
<li>Security group: Tạo security group mới: <strong>SG-Pub-Bra-ASG</strong></li>
<li>Type: <strong>SSH</strong>; Source: <strong>My IP</strong></li>
<li>Type: <strong>All TCP</strong>; Source: Custom, <code>10.1.0.0/16</code></li>
<li>Type: <strong>All UDP</strong>; Source: Custom, <code>10.1.0.0/16</code></li>
<li>Type: <strong>All ICMP - IPv4</strong>; Source: Custom, <code>10.1.0.0/16</code></li>
</ul>
<p><strong>Tạo EC2 thuộc mạng của Main Office</strong></p>
<ul>
<li>AMI: <strong>Amazon Linux 2</strong></li>
<li>Instance type: <strong>t2.medium</strong></li>
<li>Network: <strong>VPC-Main-ASG</strong></li>
<li>Subnet: <strong>Pubsub1-Main-ASG</strong></li>
<li>Auto-assign Public IP: <strong>Enable</strong></li>
<li>Security group: <strong>SG-Pub-Main-ASG</strong></li>
<li>Key pair: <strong>Create a new key pair</strong>: <code>awskey2</code></li>
</ul>
<p><strong>Tạo EC2 thuộc mạng của Branch Office</strong></p>
<ul>
<li>AMI: <strong>Amazon Linux 2</strong></li>
<li>Instance type: <strong>t2.medium</strong></li>
<li>Network: <strong>VPC-Bra-ASG</strong></li>
<li>Subnet: <strong>Pubsub-Bra-ASG</strong></li>
<li>Auto-assign Public IP: <strong>Enable</strong></li>
<li>Security group: <strong>SG-Pub-Bra-ASG</strong></li>
<li>Key pair: <strong>Create a new key pair</strong>: <code>awskey2</code></li>
</ul>
<h4 id="3-cấu-hình-site-to-site-vpn-tại-main-office">3. Cấu hình Site to Site VPN tại Main office</h4>
<p><strong>Tạo Virtual Private Gateway tại Main Office</strong></p>
<ul>
<li>Truy cập trang Amazon VPC console tại địa chỉ <a href="https://console.aws.amazon.com/vpc/">https://console.aws.amazon.com/vpc/</a></li>
<li>Chọn <strong>Virtual Private Gateway</strong></li>
<li>Chọn <strong>Tạo VPG</strong></li>
<li>Name: <strong>VPG-MainBranch-ASG</strong></li>
</ul>
<p><strong>Tạo &amp; cấu hình Customer Gateway tại Main Office</strong></p>
<ul>
<li>Name: <strong>CGW-MainBranch-ASG</strong></li>
<li>Routing: <strong>Static</strong></li>
<li>IP Address: <strong>13.56.76.108</strong></li>
</ul>
<p><strong>Tạo &amp; cấu hình kết nối Site-to-Site tại Main Office</strong></p>
<ul>
<li>Name: <strong>VPN-MainBranch-ASG</strong></li>
<li>Virtual Private Gateway: <strong>VPG-MainBranch-ASG</strong></li>
<li>Customer Gateway: Exist (<strong>CGW-MainBranch-ASG</strong>)</li>
<li>Routing Options: <strong>Static</strong></li>
<li>IP Prefixes: <code>10.2.0.0/16</code></li>
</ul>
<p>Bật propagate cho Route table của VPC-Main-ASG:</p>
<ul>
<li>Truy cập trang Amazon VPC console tại địa chỉ <a href="https://console.aws.amazon.com/vpc/">https://console.aws.amazon.com/vpc/</a></li>
<li>Chọn Route table thuộc Main Office : <strong>RT-Main-ASG</strong></li>
<li>Bấm <strong>Route Propagation</strong>, <strong>Edit Route Propagation</strong></li>
<li>Check <strong>Enable, Yes</strong></li>
</ul>
<h4 id="4-cấu-hình-site-to-site-vpn-tại-branch-office">4. Cấu hình Site to Site VPN tại Branch office</h4>
<p>Trên máy chủ EC2-Bra-ASG thực hiện các bước sau:</p>
<ul>
<li>Cài đặt OpenSwan</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">sudo</span> <span style="color:#a6e22e">su</span>
<span style="color:#a6e22e">yum</span> <span style="color:#a6e22e">install</span> <span style="color:#a6e22e">openswan</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">y</span>
</code></pre></div><ul>
<li>Cấu hình /etc/ipsec.conf</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">include</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">ipsec</span>.<span style="color:#a6e22e">d</span><span style="color:#f92672">/*</span>.<span style="color:#a6e22e">conf</span>
</code></pre></div><ul>
<li>Cấu hình /etc/sysctl.conf</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ipv4</span>.<span style="color:#a6e22e">ip_forward</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ipv4</span>.<span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">all</span>.<span style="color:#a6e22e">accept_redirects</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">ipv4</span>.<span style="color:#a6e22e">conf</span>.<span style="color:#a6e22e">all</span>.<span style="color:#a6e22e">send_redirects</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</code></pre></div><ul>
<li>Cấu hình /etc/ipsec.d/aws-vpn.conf</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">Tunnel1</span>
	<span style="color:#a6e22e">authby</span><span style="color:#f92672">=</span><span style="color:#a6e22e">secret</span>
	<span style="color:#a6e22e">auto</span><span style="color:#f92672">=</span><span style="color:#a6e22e">start</span>
	<span style="color:#a6e22e">left</span><span style="color:#f92672">=%</span><span style="color:#a6e22e">defaultroute</span>
	<span style="color:#a6e22e">leftid</span><span style="color:#f92672">=</span><span style="color:#ae81ff">13.56.76.108</span> 
	<span style="color:#a6e22e">right</span><span style="color:#f92672">=</span><span style="color:#ae81ff">52.53.71.108</span>
	<span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#a6e22e">tunnel</span>
	<span style="color:#a6e22e">ikelifetime</span><span style="color:#f92672">=</span><span style="color:#ae81ff">8</span><span style="color:#a6e22e">h</span>
	<span style="color:#a6e22e">keylife</span><span style="color:#f92672">=</span><span style="color:#ae81ff">1</span><span style="color:#a6e22e">h</span>
	<span style="color:#a6e22e">phase2alg</span><span style="color:#f92672">=</span><span style="color:#a6e22e">aes128</span><span style="color:#f92672">-</span><span style="color:#a6e22e">sha1</span>;<span style="color:#a6e22e">modp1024</span>
	<span style="color:#a6e22e">ike</span><span style="color:#f92672">=</span><span style="color:#a6e22e">aes128</span><span style="color:#f92672">-</span><span style="color:#a6e22e">sha1</span>;<span style="color:#a6e22e">modp1024</span>
	<span style="color:#a6e22e">keyingtries</span><span style="color:#f92672">=%</span><span style="color:#a6e22e">forever</span>
	<span style="color:#a6e22e">keyexchange</span><span style="color:#f92672">=</span><span style="color:#a6e22e">ike</span>
	<span style="color:#a6e22e">leftsubnet</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.2.0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>
	<span style="color:#a6e22e">rightsubnet</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10.1.0.0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">16</span>
	<span style="color:#a6e22e">dpddelay</span><span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
	<span style="color:#a6e22e">dpdtimeout</span><span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>
	<span style="color:#a6e22e">dpdaction</span><span style="color:#f92672">=</span><span style="color:#a6e22e">restart_by_peer</span>
</code></pre></div><p><strong>Chú ý:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">leftid: IP Public Address of Branch office.
right: IP Public Address of AWS VPN Tunnel
leftsubnet: CIDR from Branch site 
rightsubnet: CIDR from Main site
</code></pre></div><ul>
<li>Cấu hình /etc/ipsec.d/aws-vpn.secrets</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#ae81ff">13.56.76.108</span> <span style="color:#ae81ff">52.53.71.108</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">PSK</span> <span style="color:#e6db74">&#34;vYiouHnJ1Q2itTl9NCy8zSuOOWciVmz2&#34;</span>
</code></pre></div><ul>
<li>Khởi động lại Network service &amp; IPSEC service</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#a6e22e">service</span> <span style="color:#a6e22e">network</span> <span style="color:#a6e22e">restart</span> 
<span style="color:#a6e22e">chkconfig</span> <span style="color:#a6e22e">ipsec</span> <span style="color:#a6e22e">on</span>
<span style="color:#a6e22e">service</span> <span style="color:#a6e22e">ipsec</span> <span style="color:#a6e22e">start</span>
<span style="color:#a6e22e">service</span> <span style="color:#a6e22e">ipsec</span> <span style="color:#a6e22e">status</span>
</code></pre></div><p><img src="/images/2-vpc/VPN-MainBranch-ASG.png?width=90pc" alt="Thông tin VPN đã thiết lập"></p>
<h4 id="5-test-ping-từ-pub-linux-tới-pub-linux-bra-và-ngược-lại">5. Test ping từ Pub-Linux tới Pub-Linux-Bra và ngược lại</h4>
<p><img src="/images/2-vpc/Test-ping-PubLinux-to-PubLinuxBra.png?width=90pc" alt="Testing Ping giữa các Subnet"></p>
<p><img src="/images/2-vpc/Test-ping-PubLinuxBra-to-PubLinux.png?width=90pc" alt="Testing Ping giữa các Subnet"></p>





<footer class=" footline" >
	
</footer>

        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/vi/2-vpc-security-basic/1-configure-nacl-and-sg/" title="Cấu hình NACL &amp; SG"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/vi/2-vpc-security-basic/2-configure-vpc-flow-logs/" title="Cấu hình VPC Flow Logs" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1611462586"></script>
    <script src="/js/perfect-scrollbar.min.js?1611462586"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1611462586"></script>
    <script src="/js/jquery.sticky.js?1611462586"></script>
    <script src="/js/featherlight.min.js?1611462586"></script>
    <script src="/js/highlight.pack.js?1611462586"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom-3.6.0.js?1611462586"></script>
    <script src="/js/learn.js?1611462586"></script>
    <script src="/js/hugo-learn.js?1611462586"></script>

    <link href="/mermaid/mermaid.css?1611462586" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1611462586"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-158079754-2', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
